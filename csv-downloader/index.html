<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets to CSV</title>
</head>
<body>
    <h2>Download Google Sheets as CSV</h2>
    <label for="sheetUrl">Enter Google Sheet URL:</label>
    <input type="text" id="sheetUrl" placeholder="Enter Google Sheets URL">
    <button onclick="handleAuthClick()">Download as CSV</button>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        let tokenClient;
        let accessToken = null;
        const clientId = 'YOUR_CLIENT_ID_PLACEHOLDER'; // Replace with your Google API Client ID
        const apiKey = 'YOUR_API_KEY_PLACEHOLDER'; // Replace with your Google API Key
        const scopes = "https://www.googleapis.com/auth/spreadsheets.readonly";
    
        // Initialize the Google Identity Services OAuth 2.0 client
        function initClient() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: scopes,
                callback: (response) => {
                    if (response.error) {
                        console.error(response.error);
                        return;
                    }
                    accessToken = response.access_token;
                    downloadSheetsAsCsv();
                }
            });
        }
    
        function handleAuthClick() {
            if (!accessToken) {
                tokenClient.requestAccessToken();
            } else {
                downloadSheetsAsCsv();
            }
        }
    
        function extractSheetId(url) {
            const regex = /\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
            const matches = url.match(regex);
            if (matches && matches[1]) {
                return matches[1];
            } else {
                alert("Invalid Google Sheets URL.");
                throw new Error("Invalid Google Sheets URL.");
            }
        }
    
        function downloadSheetsAsCsv() {
            const sheetUrl = document.getElementById("sheetUrl").value;
            if (!sheetUrl) {
                alert("Please enter a Google Sheets URL.");
                return;
            }
    
            const sheetId = extractSheetId(sheetUrl);
            
            // Use the access token to make authorized requests to the Google Sheets API
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?key=${apiKey}`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const sheets = data.sheets;
                sheets.forEach(sheet => {
                    const sheetName = sheet.properties.title;
    
                    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?key=${apiKey}`, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    })
                    .then(response => response.json())
                    .then(csvData => {
                        const csvContent = convertToCsv(csvData.values);
                        downloadFile(`${sheetName}.csv`, csvContent);
                    });
                });
            });
        }
    
        function convertToCsv(data) {
            return data.map(row => row.join(",")).join("\n");
        }
    
        function downloadFile(fileName, content) {
            const blob = new Blob([content], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }
    
        // Load the Google Identity Services library and initialize the client
        window.onload = () => {
            initClient();
        };
    </script>
</body>
</html>