<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets to CSV</title>
</head>
<body>
    <h2>Download Google Sheets as CSV</h2>
    <label for="sheetUrl">Enter Google Sheet URL:</label>
    <input type="text" id="sheetUrl" placeholder="Enter Google Sheets URL">
    <button onclick="authorizeAndDownload()">Download as CSV</button>

    <script>
        const clientId = 'YOUR_CLIENT_ID_PLACEHOLDER'; // Replace with your Google API Client ID
        const apiKey = 'YOUR_API_KEY_PLACEHOLDER'; // Replace with your Google API Key
        const discoveryDocs = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const scopes = "https://www.googleapis.com/auth/spreadsheets.readonly";

        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        function initClient() {
            gapi.client.init({
                apiKey: apiKey,
                clientId: clientId,
                discoveryDocs: discoveryDocs,
                scope: scopes
            }).then(() => {
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            });
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                // User is signed in
            } else {
                // User not signed in
            }
        }

        function authorizeAndDownload() {
            const sheetUrl = document.getElementById("sheetUrl").value;
            if (!sheetUrl) {
                alert("Please enter a Google Sheets URL.");
                return;
            }

            gapi.auth2.getAuthInstance().signIn().then(() => {
                const sheetId = extractSheetId(sheetUrl);
                downloadSheetsAsCsv(sheetId);
            });
        }

        function extractSheetId(url) {
            const regex = /\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
            const matches = url.match(regex);
            if (matches && matches[1]) {
                return matches[1];
            } else {
                alert("Invalid Google Sheets URL.");
                throw new Error("Invalid Google Sheets URL.");
            }
        }

        function downloadSheetsAsCsv(sheetId) {
            gapi.client.sheets.spreadsheets.get({
                spreadsheetId: sheetId
            }).then(response => {
                const sheets = response.result.sheets;
                sheets.forEach(sheet => {
                    const sheetName = sheet.properties.title;
                    const sheetId = sheet.properties.sheetId;

                    gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: sheetId,
                        range: `${sheetName}!A:Z`
                    }).then(csvData => {
                        const csvContent = convertToCsv(csvData.result.values);
                        downloadFile(`${sheetName}.csv`, csvContent);
                    });
                });
            });
        }

        function convertToCsv(data) {
            return data.map(row => row.join(",")).join("\n");
        }

        function downloadFile(fileName, content) {
            const blob = new Blob([content], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }

        // Load the API and make the auth2 library available
        function loadGapi() {
            const script = document.createElement("script");
            script.src = "https://apis.google.com/js/api.js";
            script.onload = () => handleClientLoad();
            document.body.appendChild(script);
        }

        loadGapi();
    </script>
</body>
</html>